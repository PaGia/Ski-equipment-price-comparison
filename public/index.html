<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›ªæ¿åƒ¹æ ¼æ¯”è¼ƒå™¨</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: #fff;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      background: linear-gradient(90deg, #00d2ff, #3a7bd5);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-info {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .stat-badge {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .store-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .store-badge.murasaki {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: 1px solid rgba(255, 107, 107, 0.3);
    }

    .store-badge.northshore {
      background: rgba(0, 210, 255, 0.2);
      color: #00d2ff;
      border: 1px solid rgba(0, 210, 255, 0.3);
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(90deg, #00d2ff, #3a7bd5);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 210, 255, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .view-toggle {
      display: flex;
      gap: 5px;
    }

    .view-btn {
      padding: 10px 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2rem;
    }

    .view-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .view-btn.active {
      background: rgba(0, 210, 255, 0.3);
      border-color: #00d2ff;
    }

    .filters {
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 0 20px 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-group label {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .filter-group input,
    .filter-group select {
      padding: 10px 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 0.9rem;
      min-width: 150px;
    }

    .filter-group input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .filter-group select option {
      background: #1a1a2e;
      color: #fff;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: #00d2ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Grid View */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .product-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      border-color: rgba(0, 210, 255, 0.3);
    }

    .product-image {
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: #fff;
      padding: 10px;
    }

    .product-image-placeholder {
      width: 100%;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.5);
      font-size: 3rem;
    }

    .product-info {
      padding: 15px;
    }

    .product-brand {
      font-size: 0.8rem;
      color: #00d2ff;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;
    }

    .product-name {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .product-price-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .lowest-price {
      color: #00ff88;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .store-count {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
    }

    .expand-btn {
      width: 100%;
      padding: 10px;
      background: rgba(0, 210, 255, 0.1);
      border: none;
      color: #00d2ff;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .expand-btn:hover {
      background: rgba(0, 210, 255, 0.2);
    }

    .expand-btn .arrow {
      transition: transform 0.3s ease;
    }

    .expand-btn.expanded .arrow {
      transform: rotate(180deg);
    }

    .store-list {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: rgba(0, 0, 0, 0.2);
    }

    .store-list.expanded {
      max-height: 500px;
    }

    .store-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      gap: 10px;
    }

    .store-item:first-child {
      border-top: none;
    }

    .store-item.best-price {
      background: rgba(0, 255, 136, 0.1);
    }

    .store-item .store-info {
      flex: 1;
    }

    .store-item .store-name {
      font-weight: 500;
      font-size: 0.9rem;
    }

    .store-item .store-currency {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .store-item .store-price {
      text-align: right;
    }

    .store-item .price-local {
      font-weight: 700;
      font-size: 1rem;
    }

    .store-item .price-jpy {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .store-item .store-link {
      padding: 6px 12px;
      background: rgba(0, 210, 255, 0.2);
      color: #00d2ff;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .store-item .store-link:hover {
      background: rgba(0, 210, 255, 0.4);
    }

    /* List View */
    .product-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .product-list .product-card {
      border-radius: 12px;
    }

    .product-list .product-main {
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .product-list .product-main:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .product-list .product-image-container {
      flex-shrink: 0;
      width: 80px;
      height: 80px;
      background: #fff;
      border-radius: 8px;
      margin: 10px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-list .product-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 5px;
    }

    .product-list .product-image-placeholder {
      width: 100%;
      height: 100%;
      font-size: 2rem;
    }

    .product-list .product-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px 15px;
    }

    .product-list .product-details {
      flex: 1;
      min-width: 0;
    }

    .product-list .product-brand {
      margin-bottom: 2px;
    }

    .product-list .product-name {
      margin-bottom: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-list .product-price-info {
      flex-shrink: 0;
      text-align: right;
    }

    .product-list .lowest-price {
      font-size: 1.1rem;
    }

    .product-list .lowest-store {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .product-list .expand-indicator {
      padding: 10px 15px;
      color: #00d2ff;
      font-size: 1.2rem;
      transition: transform 0.3s ease;
    }

    .product-list .expand-indicator.expanded {
      transform: rotate(180deg);
    }

    .no-data {
      text-align: center;
      padding: 50px;
      color: rgba(255, 255, 255, 0.7);
    }

    .no-data h2 {
      margin-bottom: 10px;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      color: #fff;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      background: linear-gradient(90deg, #00b894, #00cec9);
    }

    .toast.error {
      background: linear-gradient(90deg, #ff6b6b, #ee5a24);
    }

    .toast.info {
      background: linear-gradient(90deg, #00d2ff, #3a7bd5);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .summary-card h3 {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 10px;
    }

    .summary-card .value {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, #00d2ff, #3a7bd5);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .multi-store-badge {
      background: linear-gradient(90deg, #ff6b6b, #ee5a24);
      color: #fff;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 700;
      margin-left: 8px;
    }

    /* æ–°å¢åº—å®¶æŒ‰éˆ• */
    .add-store-btn {
      padding: 8px 12px;
      background: linear-gradient(90deg, #00b894, #00cec9);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: 10px;
    }

    .add-store-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
    }

    .store-filter-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 5px;
    }

    /* Modal å°è©±æ¡† */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal h2 {
      margin-bottom: 20px;
      background: linear-gradient(90deg, #00b894, #00cec9);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .modal-form label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .modal-form input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 1rem;
    }

    .modal-form input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .modal-form input:focus {
      outline: none;
      border-color: #00b894;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .modal-buttons .btn {
      flex: 1;
    }

    .btn-success {
      background: linear-gradient(90deg, #00b894, #00cec9);
      color: #fff;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
    }

    .btn-success:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-cancel {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-cancel:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-hint {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 5px;
    }

    .modal-result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }

    .modal-result.success {
      display: block;
      background: rgba(0, 184, 148, 0.2);
      border: 1px solid rgba(0, 184, 148, 0.3);
    }

    .modal-result.error {
      display: block;
      background: rgba(255, 107, 107, 0.2);
      border: 1px solid rgba(255, 107, 107, 0.3);
    }

    .modal-result.warning {
      display: block;
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .modal-result h4 {
      margin-bottom: 8px;
    }

    .modal-result p {
      font-size: 0.9rem;
      margin: 3px 0;
    }

    /* è‡ªè¨‚åº—å®¶æ¨™ç±¤ */
    .store-badge.custom {
      background: rgba(0, 184, 148, 0.2);
      color: #00b894;
      border: 1px solid rgba(0, 184, 148, 0.3);
    }

    .delete-store-btn {
      padding: 4px 8px;
      background: rgba(255, 107, 107, 0.2);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 4px;
      color: #ff6b6b;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .delete-store-btn:hover {
      background: rgba(255, 107, 107, 0.4);
    }

    /* åº—å®¶ç®¡ç† Modal åˆ†é  */
    .modal-tabs {
      display: flex;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 20px;
    }

    .modal-tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      position: relative;
    }

    .modal-tab:hover {
      color: rgba(255, 255, 255, 0.9);
    }

    .modal-tab.active {
      color: #00b894;
    }

    .modal-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #00b894, #00cec9);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* åº—å®¶åˆ—è¡¨æ¨£å¼ */
    .store-list-manage {
      max-height: 350px;
      overflow-y: auto;
    }

    .store-manage-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .store-manage-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .store-manage-info {
      flex: 1;
    }

    .store-manage-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .store-manage-meta {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .store-manage-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      margin-left: 8px;
    }

    .store-manage-type.builtin {
      background: rgba(0, 210, 255, 0.2);
      color: #00d2ff;
    }

    .store-manage-type.custom {
      background: rgba(0, 184, 148, 0.2);
      color: #00b894;
    }

    .store-manage-actions {
      display: flex;
      gap: 8px;
    }

    .btn-delete {
      padding: 8px 16px;
      background: rgba(255, 107, 107, 0.2);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 6px;
      color: #ff6b6b;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s ease;
    }

    .btn-delete:hover {
      background: rgba(255, 107, 107, 0.4);
    }

    .btn-delete:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .empty-stores {
      text-align: center;
      padding: 30px;
      color: rgba(255, 255, 255, 0.5);
    }

    /* é€²åº¦æ¢æ¨£å¼ */
    .progress-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      z-index: 200;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
      border-bottom: 1px solid rgba(0, 210, 255, 0.3);
    }

    .progress-container.active {
      transform: translateY(0);
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .progress-title {
      font-size: 1.1rem;
      font-weight: 500;
      color: #00d2ff;
    }

    .progress-stats {
      display: flex;
      gap: 20px;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .progress-bar-wrapper {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #00d2ff, #3a7bd5);
      border-radius: 10px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: #fff;
      min-width: 40px;
    }

    .progress-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
    }

    .progress-message {
      flex: 1;
    }

    .progress-time {
      color: #00d2ff;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.5rem;
      }

      .product-grid {
        grid-template-columns: 1fr;
      }

      .filters {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group input,
      .filter-group select {
        width: 100%;
      }

      .product-list .product-info {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- é€²åº¦æ¢ -->
  <div class="progress-container" id="progressContainer">
    <div class="progress-header">
      <span class="progress-title">æ­£åœ¨æŠ“å–è³‡æ–™...</span>
      <div class="progress-stats">
        <span id="progressStore">åº—å®¶: -</span>
        <span id="progressProducts">å•†å“: 0</span>
      </div>
    </div>
    <div class="progress-bar-wrapper">
      <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
    </div>
    <div class="progress-details">
      <span class="progress-message" id="progressMessage">æº–å‚™ä¸­...</span>
      <span class="progress-time" id="progressTime">å·²èŠ±è²»: 0ç§’</span>
    </div>
  </div>

  <header class="header">
    <h1>ğŸ‚ é›ªæ¿åƒ¹æ ¼æ¯”è¼ƒå™¨</h1>
    <div class="header-info">
      <span class="stat-badge" id="lastUpdated">æœ€å¾Œæ›´æ–°: è¼‰å…¥ä¸­...</span>
      <span class="stat-badge" id="totalProducts">å•†å“æ•¸: -</span>
      <span class="stat-badge" id="storeInfo">åº—å®¶: -</span>
    </div>
  </header>

  <div class="controls">
    <button class="btn btn-primary" id="refreshBtn" onclick="triggerScrape()">
      <span>ğŸ”„</span> æ›´æ–°å…¨éƒ¨è³‡æ–™
    </button>
    <button class="btn btn-secondary" onclick="loadProducts()">
      <span>ğŸ“Š</span> é‡æ–°è¼‰å…¥
    </button>
    <div class="view-toggle">
      <button class="view-btn active" id="gridViewBtn" onclick="setViewMode('grid')" title="å¡ç‰‡æª¢è¦–">
        â–¦
      </button>
      <button class="view-btn" id="listViewBtn" onclick="setViewMode('list')" title="åˆ—è¡¨æª¢è¦–">
        â˜°
      </button>
    </div>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label>æœå°‹å•†å“</label>
      <input type="text" id="searchInput" placeholder="å“ç‰Œæˆ–å•†å“åç¨±..." oninput="filterProducts()">
    </div>
    <div class="filter-group">
      <label id="priceFilterLabel">åƒ¹æ ¼ç¯„åœ (JPY)</label>
      <select id="priceFilter" onchange="filterProducts()">
        <option value="">å…¨éƒ¨åƒ¹æ ¼</option>
        <option value="0-30000" data-jpy="0-30000">Â¥30,000 ä»¥ä¸‹</option>
        <option value="30000-50000" data-jpy="30000-50000">Â¥30,000 - Â¥50,000</option>
        <option value="50000-80000" data-jpy="50000-80000">Â¥50,000 - Â¥80,000</option>
        <option value="80000-100000" data-jpy="80000-100000">Â¥80,000 - Â¥100,000</option>
        <option value="100000-999999" data-jpy="100000-999999">Â¥100,000 ä»¥ä¸Š</option>
      </select>
    </div>
    <div class="filter-group">
      <label>åº—å®¶ç¯©é¸</label>
      <div class="store-filter-wrapper">
        <select id="storeFilter" onchange="filterProducts()">
          <option value="">å…¨éƒ¨åº—å®¶</option>
          <option value="multi">å¤šåº—æ¯”åƒ¹</option>
        </select>
        <button class="add-store-btn" onclick="openStoreModal('list')" title="ç®¡ç†åº—å®¶">...</button>
      </div>
    </div>
    <div class="filter-group">
      <label>è£å‚™é¡å‹</label>
      <select id="categoryFilter" onchange="filterProducts()">
        <option value="all">å…¨éƒ¨è£å‚™</option>
        <!-- å‹•æ…‹å¡«å……åˆ†é¡é¸é … -->
      </select>
    </div>
    <div class="filter-group">
      <label>æ’åºæ–¹å¼</label>
      <select id="sortFilter" onchange="filterProducts()">
        <option value="price-asc">åƒ¹æ ¼ä½åˆ°é«˜</option>
        <option value="price-desc">åƒ¹æ ¼é«˜åˆ°ä½</option>
        <option value="stores-desc">æ¯”åƒ¹åº—å®¶å¤š</option>
        <option value="name-asc">åç¨± A-Z</option>
      </select>
    </div>
    <div class="filter-group">
      <label>é¡¯ç¤ºå¹£åˆ¥</label>
      <select id="currencyFilter" onchange="changeCurrency()">
        <option value="JPY">ğŸ‡¯ğŸ‡µ JPY æ—¥åœ“</option>
        <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD å°å¹£</option>
        <option value="USD">ğŸ‡ºğŸ‡¸ USD ç¾å…ƒ</option>
        <option value="CAD">ğŸ‡¨ğŸ‡¦ CAD åŠ å¹£</option>
        <option value="EUR">ğŸ‡ªğŸ‡º EUR æ­å…ƒ</option>
        <option value="GBP">ğŸ‡¬ğŸ‡§ GBP è‹±éŠ</option>
        <option value="AUD">ğŸ‡¦ğŸ‡º AUD æ¾³å¹£</option>
      </select>
    </div>
  </div>

  <div class="container">
    <div class="summary-cards" id="summaryCards" style="display: none;">
      <div class="summary-card">
        <h3>ç¸½å•†å“æ•¸</h3>
        <div class="value" id="displayCount">-</div>
      </div>
      <div class="summary-card">
        <h3>å¯æ¯”åƒ¹å•†å“</h3>
        <div class="value" id="multiStoreCount">-</div>
      </div>
      <div class="summary-card">
        <h3>åƒ¹æ ¼ç¯„åœ</h3>
        <div class="value" id="avgPrice">-</div>
      </div>
      <div class="summary-card">
        <h3>åº—å®¶æ•¸é‡</h3>
        <div class="value" id="storeCount">-</div>
      </div>
    </div>

    <div id="content">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>è¼‰å…¥å•†å“è³‡æ–™ä¸­...</p>
      </div>
    </div>
  </div>

  <!-- åº—å®¶ç®¡ç† Modal -->
  <div class="modal-overlay" id="storeModal">
    <div class="modal">
      <h2>åº—å®¶ç®¡ç†</h2>

      <!-- åˆ†é æ¨™ç±¤ -->
      <div class="modal-tabs">
        <button class="modal-tab active" onclick="switchStoreTab('list')">ç¾æœ‰åº—å®¶</button>
        <button class="modal-tab" onclick="switchStoreTab('add')">æ–°å¢åº—å®¶</button>
      </div>

      <!-- åº—å®¶åˆ—è¡¨åˆ†é  -->
      <div class="tab-content active" id="storeListTab">
        <div class="store-list-manage" id="storeListManage">
          <div class="empty-stores">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="modal-buttons" style="margin-top: 15px;">
          <button type="button" class="btn btn-cancel" onclick="closeStoreModal()">é—œé–‰</button>
        </div>
      </div>

      <!-- æ–°å¢åº—å®¶åˆ†é  -->
      <div class="tab-content" id="addStoreTab">
        <!-- Step 1: è¼¸å…¥ç¶²å€ -->
        <div id="addStoreStep1">
          <form class="modal-form" onsubmit="exploreStoreCategories(event)">
            <div>
              <label>åº—å®¶ç¶²å€ *</label>
              <input type="url" id="storeUrl" placeholder="https://example.com/products" required>
              <p class="modal-hint">è«‹è²¼ä¸Šè©²åº—å®¶çš„å•†å“åˆ—è¡¨é é¢ç¶²å€</p>
            </div>
            <div>
              <label>åº—å®¶åç¨± (é¸å¡«)</label>
              <input type="text" id="storeName" placeholder="æœƒè‡ªå‹•å¾ç¶²ç«™åµæ¸¬">
              <p class="modal-hint">è‹¥ä¸å¡«å¯«ï¼Œç³»çµ±æœƒè‡ªå‹•å¾ç¶²å€åµæ¸¬åº—å®¶åç¨±</p>
            </div>
            <div class="modal-buttons">
              <button type="button" class="btn btn-cancel" onclick="closeStoreModal()">å–æ¶ˆ</button>
              <button type="submit" class="btn btn-success" id="exploreStoreBtn">æ¢ç´¢åˆ†é¡</button>
            </div>
          </form>
        </div>

        <!-- Step 2: é¸æ“‡åˆ†é¡ -->
        <div id="addStoreStep2" style="display: none;">
          <div class="modal-form">
            <div style="margin-bottom: 15px;">
              <h4 style="margin: 0 0 5px 0;" id="exploredStoreName">åº—å®¶åç¨±</h4>
              <p style="color: #888; font-size: 0.85rem; margin: 0;" id="exploredStoreUrl">ç¶²å€</p>
            </div>
            <div>
              <label>é¸æ“‡è¦æŠ“å–çš„åˆ†é¡</label>
              <div id="categoryList" style="max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;">
                <!-- åˆ†é¡æ¸…å–®æœƒå‹•æ…‹å¡«å…¥ -->
              </div>
              <p class="modal-hint">å‹¾é¸ä½ æƒ³è¦æŠ“å–çš„å•†å“åˆ†é¡ï¼ˆå¦‚ï¼šé›ªæ¿ã€å›ºå®šå™¨ã€é›ªé´ç­‰ï¼‰</p>
            </div>
            <div class="modal-buttons">
              <button type="button" class="btn btn-cancel" onclick="backToStep1()">ä¸Šä¸€æ­¥</button>
              <button type="button" class="btn btn-success" id="addStoreSubmitBtn" onclick="submitAddStoreWithCategories()">æ–°å¢åº—å®¶</button>
            </div>
          </div>
        </div>

        <div class="modal-result" id="addStoreResult"></div>
      </div>
    </div>
  </div>

  <script>
    let allProducts = [];
    let storesData = [];
    let exchangeRates = {};
    let currentViewMode = 'grid';
    let currentFilteredProducts = [];
    let expandedProducts = new Set();
    let currentCurrency = 'JPY';

    // å¹£åˆ¥ç¬¦è™Ÿå°ç…§è¡¨
    const currencySymbols = {
      JPY: 'Â¥',
      TWD: 'NT$',
      USD: '$',
      CAD: 'C$',
      EUR: 'â‚¬',
      GBP: 'Â£',
      AUD: 'A$'
    };

    // å¹£åˆ¥å°æ•¸ä½æ•¸
    const currencyDecimals = {
      JPY: 0,
      TWD: 0,
      USD: 2,
      CAD: 2,
      EUR: 2,
      GBP: 2,
      AUD: 2
    };

    // å¾ JPY è½‰æ›åˆ°ç›®æ¨™å¹£åˆ¥
    function convertFromJPY(amountJPY, toCurrency) {
      if (!amountJPY || toCurrency === 'JPY') return amountJPY;
      const rate = exchangeRates[toCurrency];
      if (!rate) return amountJPY;
      return amountJPY / rate;
    }

    // åˆ‡æ›å¹£åˆ¥
    function changeCurrency() {
      currentCurrency = document.getElementById('currencyFilter').value;
      updatePriceFilterOptions();
      renderProducts(currentFilteredProducts);
      updateSummary(currentFilteredProducts);
    }

    // æ›´æ–°åƒ¹æ ¼ç¯©é¸é¸é …çš„é¡¯ç¤º
    function updatePriceFilterOptions() {
      const priceFilter = document.getElementById('priceFilter');
      const priceFilterLabel = document.getElementById('priceFilterLabel');

      // æ›´æ–°æ¨™ç±¤
      priceFilterLabel.textContent = `åƒ¹æ ¼ç¯„åœ (${currentCurrency})`;

      // åƒ¹æ ¼å€é–“å®šç¾© (ä»¥ JPY ç‚ºåŸºæº–)
      const priceRanges = [
        { value: '0-30000', jpyMin: 0, jpyMax: 30000, labelKey: 'under' },
        { value: '30000-50000', jpyMin: 30000, jpyMax: 50000, labelKey: 'range' },
        { value: '50000-80000', jpyMin: 50000, jpyMax: 80000, labelKey: 'range' },
        { value: '80000-100000', jpyMin: 80000, jpyMax: 100000, labelKey: 'range' },
        { value: '100000-999999', jpyMin: 100000, jpyMax: 999999, labelKey: 'over' }
      ];

      // æ›´æ–°å„é¸é …çš„é¡¯ç¤ºæ–‡å­—
      const options = priceFilter.querySelectorAll('option[data-jpy]');
      options.forEach((option, index) => {
        const range = priceRanges[index];
        const minConverted = convertFromJPY(range.jpyMin, currentCurrency);
        const maxConverted = convertFromJPY(range.jpyMax, currentCurrency);

        if (range.labelKey === 'under') {
          option.textContent = `${formatPrice(maxConverted, currentCurrency)} ä»¥ä¸‹`;
        } else if (range.labelKey === 'over') {
          option.textContent = `${formatPrice(minConverted, currentCurrency)} ä»¥ä¸Š`;
        } else {
          option.textContent = `${formatPrice(minConverted, currentCurrency)} - ${formatPrice(maxConverted, currentCurrency)}`;
        }
      });
    }

    // æ ¼å¼åŒ–åƒ¹æ ¼ (ä½¿ç”¨æŒ‡å®šå¹£åˆ¥)
    function formatPrice(price, currency = 'JPY') {
      if (!price) return '-';
      const symbol = currencySymbols[currency] || '';
      const decimals = currencyDecimals[currency] || 0;

      if (decimals === 0) {
        return symbol + Math.round(price).toLocaleString();
      } else {
        return symbol + price.toLocaleString(undefined, {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        });
      }
    }

    // æ ¼å¼åŒ–åƒ¹æ ¼ (é¡¯ç¤ºç•¶å‰é¸æ“‡çš„å¹£åˆ¥ï¼Œå¾ JPY è½‰æ›)
    function formatPriceInCurrentCurrency(priceJPY) {
      if (!priceJPY) return '-';
      const converted = convertFromJPY(priceJPY, currentCurrency);
      return formatPrice(converted, currentCurrency);
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateStr) {
      if (!dateStr) return 'å°šæœªæ›´æ–°';
      const date = new Date(dateStr);
      return date.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // é¡¯ç¤º Toast è¨Šæ¯
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // è¨­å®šæª¢è¦–æ¨¡å¼
    function setViewMode(mode) {
      currentViewMode = mode;
      document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
      document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
      renderProducts(currentFilteredProducts);
    }

    // åˆ‡æ›å±•é–‹ç‹€æ…‹
    function toggleExpand(productKey) {
      if (expandedProducts.has(productKey)) {
        expandedProducts.delete(productKey);
      } else {
        expandedProducts.add(productKey);
      }
      renderProducts(currentFilteredProducts);
    }

    // è¼‰å…¥å•†å“è³‡æ–™
    async function loadProducts() {
      const content = document.getElementById('content');
      content.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>è¼‰å…¥å•†å“è³‡æ–™ä¸­...</p>
        </div>
      `;

      try {
        const response = await fetch('/api/products');
        const data = await response.json();

        document.getElementById('lastUpdated').textContent =
          `æœ€å¾Œæ›´æ–°: ${formatDate(data.lastUpdated)}`;
        document.getElementById('totalProducts').textContent =
          `å•†å“æ•¸: ${data.totalProducts || 0}`;

        storesData = data.stores || [];
        exchangeRates = data.exchangeRates || {};
        allProducts = data.products || [];

        // æ›´æ–°åº—å®¶ç¯©é¸é¸é …
        const storeFilter = document.getElementById('storeFilter');
        storeFilter.innerHTML = '<option value="">å…¨éƒ¨åº—å®¶</option><option value="multi">å¤šåº—æ¯”åƒ¹</option>';
        storesData.forEach(store => {
          storeFilter.innerHTML += `<option value="${store.id}">${store.name}</option>`;
        });

        document.getElementById('storeInfo').textContent =
          `åº—å®¶: ${storesData.map(s => s.name).join(', ')}`;

        if (allProducts.length === 0) {
          content.innerHTML = `
            <div class="no-data">
              <h2>å°šç„¡å•†å“è³‡æ–™</h2>
              <p>è«‹é»æ“Šã€Œæ›´æ–°å…¨éƒ¨è³‡æ–™ã€æŒ‰éˆ•é–‹å§‹æŠ“å–</p>
            </div>
          `;
          document.getElementById('summaryCards').style.display = 'none';
        } else {
          document.getElementById('summaryCards').style.display = 'grid';
          // æ›´æ–°åˆ†é¡ç¯©é¸é¸å–®
          updateCategoryFilter();
          filterProducts();
        }
      } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—:', error);
        content.innerHTML = `
          <div class="no-data">
            <h2>è¼‰å…¥å¤±æ•—</h2>
            <p>${error.message}</p>
          </div>
        `;
        showToast('è¼‰å…¥è³‡æ–™å¤±æ•—', 'error');
      }
    }

    // ç¯©é¸å’Œæ’åºå•†å“
    // åˆ†é¡åç¨±å°æ‡‰ (æ¨™æº–åŒ–ä¸åŒèªè¨€çš„åˆ†é¡åç¨±)
    const categoryMapping = {
      // é›ªæ¿
      'ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰': 'snowboard',
      'ãƒœãƒ¼ãƒ‰': 'snowboard',
      'snowboard': 'snowboard',
      'snowboards': 'snowboard',
      'board': 'snowboard',
      // å›ºå®šå™¨
      'ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°': 'binding',
      'ãƒ“ãƒ³ãƒ‡ã‚£ãƒ³ã‚°': 'binding',
      'binding': 'binding',
      'bindings': 'binding',
      // é›ªé´
      'ãƒ–ãƒ¼ãƒ„': 'boots',
      'boot': 'boots',
      'boots': 'boots',
      // å®‰å…¨å¸½
      'ãƒ˜ãƒ«ãƒ¡ãƒƒãƒˆ': 'helmet',
      'helmet': 'helmet',
      'helmets': 'helmet',
      // è­·ç›®é¡
      'ã‚´ãƒ¼ã‚°ãƒ«': 'goggle',
      'goggle': 'goggle',
      'goggles': 'goggle',
      // æ‰‹å¥—
      'ã‚°ãƒ­ãƒ¼ãƒ–': 'glove',
      'glove': 'glove',
      'gloves': 'glove',
      // æœè£
      'ã‚¦ã‚§ã‚¢': 'wear',
      'wear': 'wear',
      'ã‚¸ãƒ£ã‚±ãƒƒãƒˆ': 'jacket',
      'jacket': 'jacket',
      'ãƒ‘ãƒ³ãƒ„': 'pants',
      'pants': 'pants',
      // é…ä»¶
      'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼': 'accessory',
      'accessory': 'accessory',
      'accessories': 'accessory'
    };

    // åˆ†é¡é¡¯ç¤ºåç¨±
    const categoryDisplayNames = {
      'snowboard': 'é›ªæ¿',
      'binding': 'å›ºå®šå™¨',
      'boots': 'é›ªé´',
      'helmet': 'å®‰å…¨å¸½',
      'goggle': 'è­·ç›®é¡',
      'glove': 'æ‰‹å¥—',
      'wear': 'æœè£',
      'jacket': 'å¤–å¥—',
      'pants': 'é›ªè¤²',
      'accessory': 'é…ä»¶'
    };

    // æ¨™æº–åŒ–åˆ†é¡åç¨±
    function normalizeCategory(categoryName) {
      if (!categoryName) return null;
      const lower = categoryName.toLowerCase();
      return categoryMapping[lower] || categoryMapping[categoryName] || categoryName;
    }

    // æ›´æ–°åˆ†é¡ç¯©é¸é¸å–®
    function updateCategoryFilter() {
      const categoryFilter = document.getElementById('categoryFilter');
      const currentValue = categoryFilter.value;

      // æ”¶é›†æ‰€æœ‰å•†å“çš„åˆ†é¡
      const allCategories = new Set();
      allProducts.forEach(product => {
        if (product.categories && product.categories.length > 0) {
          product.categories.forEach(cat => {
            const normalized = normalizeCategory(cat);
            if (normalized) allCategories.add(normalized);
          });
        }
      });

      // ä¿ç•™ã€Œå…¨éƒ¨è£å‚™ã€é¸é …
      categoryFilter.innerHTML = '<option value="all">å…¨éƒ¨è£å‚™</option>';

      // å®šç¾©æ’åºé †åº
      const categoryOrder = ['snowboard', 'binding', 'boots', 'helmet', 'goggle', 'glove', 'wear', 'jacket', 'pants', 'accessory'];

      // æŒ‰é †åºæ·»åŠ åˆ†é¡é¸é …
      categoryOrder.forEach(cat => {
        if (allCategories.has(cat)) {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = categoryDisplayNames[cat] || cat;
          categoryFilter.appendChild(option);
        }
      });

      // æ·»åŠ å…¶ä»–æœªåœ¨é è¨­é †åºä¸­çš„åˆ†é¡
      allCategories.forEach(cat => {
        if (!categoryOrder.includes(cat)) {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = categoryDisplayNames[cat] || cat;
          categoryFilter.appendChild(option);
        }
      });

      // å¦‚æœä¹‹å‰é¸æ“‡çš„å€¼é‚„å­˜åœ¨ï¼Œæ¢å¾©é¸æ“‡
      if (currentValue && Array.from(categoryFilter.options).some(opt => opt.value === currentValue)) {
        categoryFilter.value = currentValue;
      } else if (allCategories.has('snowboard')) {
        // é è¨­é¸æ“‡é›ªæ¿
        categoryFilter.value = 'snowboard';
      }
    }

    function matchCategory(product, category) {
      if (category === 'all') return true;

      // å¦‚æœå•†å“æœ‰åˆ†é¡è³‡è¨Šï¼Œæ ¹æ“šåˆ†é¡ç¯©é¸
      if (product.categories && product.categories.length > 0) {
        return product.categories.some(cat => normalizeCategory(cat) === category);
      }

      // å¦‚æœæ²’æœ‰åˆ†é¡è³‡è¨Šï¼Œä½¿ç”¨é—œéµå­—åŒ¹é…ï¼ˆå‘å¾Œç›¸å®¹èˆŠè³‡æ–™ï¼‰
      const name = ((product.brand || '') + ' ' + (product.name || '')).toLowerCase();

      // é—œéµå­—åŒ¹é…
      const keywords = {
        snowboard: ['snowboard', 'ãƒœãƒ¼ãƒ‰', 'ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰', 'æ¿'],
        binding: ['binding', 'bindings', 'ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°', 'ãƒ“ãƒ³ãƒ‡ã‚£ãƒ³ã‚°'],
        boots: ['boot', 'boots', 'ãƒ–ãƒ¼ãƒ„'],
        helmet: ['helmet', 'ãƒ˜ãƒ«ãƒ¡ãƒƒãƒˆ'],
        goggle: ['goggle', 'ã‚´ãƒ¼ã‚°ãƒ«'],
        glove: ['glove', 'ã‚°ãƒ­ãƒ¼ãƒ–'],
        wear: ['wear', 'ã‚¦ã‚§ã‚¢'],
        jacket: ['jacket', 'ã‚¸ãƒ£ã‚±ãƒƒãƒˆ'],
        pants: ['pant', 'pants', 'ãƒ‘ãƒ³ãƒ„']
      };

      if (keywords[category]) {
        return keywords[category].some(kw => name.includes(kw));
      }

      return true;
    }

    function filterProducts() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const priceRange = document.getElementById('priceFilter').value;
      const storeFilter = document.getElementById('storeFilter').value;
      const categoryFilter = document.getElementById('categoryFilter').value;
      const sort = document.getElementById('sortFilter').value;

      let filtered = allProducts.filter(product => {
        // æœå°‹ç¯©é¸
        const matchSearch = !search ||
          (product.brand && product.brand.toLowerCase().includes(search)) ||
          (product.name && product.name.toLowerCase().includes(search));

        // åƒ¹æ ¼ç¯©é¸
        let matchPrice = true;
        if (priceRange) {
          const [min, max] = priceRange.split('-').map(Number);
          const price = product.lowestPrice || 0;
          matchPrice = price >= min && price <= max;
        }

        // åº—å®¶ç¯©é¸
        let matchStore = true;
        if (storeFilter === 'multi') {
          matchStore = product.storeCount > 1;
        } else if (storeFilter) {
          matchStore = product.stores.some(s => s.store === storeFilter);
        }

        // è£å‚™é¡å‹ç¯©é¸
        const matchCat = matchCategory(product, categoryFilter);

        return matchSearch && matchPrice && matchStore && matchCat;
      });

      // æ’åº
      filtered.sort((a, b) => {
        switch (sort) {
          case 'price-asc':
            return (a.lowestPrice || Infinity) - (b.lowestPrice || Infinity);
          case 'price-desc':
            return (b.lowestPrice || 0) - (a.lowestPrice || 0);
          case 'stores-desc':
            return (b.storeCount || 0) - (a.storeCount || 0);
          case 'name-asc':
            return (a.name || '').localeCompare(b.name || '');
          default:
            return 0;
        }
      });

      currentFilteredProducts = filtered;

      // æ›´æ–°çµ±è¨ˆè³‡æ–™
      updateSummary(filtered);

      // æ¸²æŸ“å•†å“
      renderProducts(filtered);
    }

    // æ›´æ–°çµ±è¨ˆæ‘˜è¦
    function updateSummary(products) {
      const prices = products.filter(p => p.lowestPrice).map(p => p.lowestPrice).sort((a, b) => a - b);
      const multiStoreProducts = products.filter(p => p.storeCount > 1);

      document.getElementById('displayCount').textContent = products.length;
      document.getElementById('multiStoreCount').textContent = multiStoreProducts.length;

      // é¡¯ç¤ºåƒ¹æ ¼ç¯„åœ
      if (prices.length > 0) {
        const minPrice = prices[0];
        const maxPrice = prices[prices.length - 1];
        const minFormatted = formatPriceInCurrentCurrency(minPrice);
        const maxFormatted = formatPriceInCurrentCurrency(maxPrice);
        document.getElementById('avgPrice').textContent = `${minFormatted} - ${maxFormatted}`;
      } else {
        document.getElementById('avgPrice').textContent = '-';
      }
      document.getElementById('storeCount').textContent = storesData.length;
    }

    // æ¸²æŸ“å•†å“åˆ—è¡¨
    function renderProducts(products) {
      const content = document.getElementById('content');

      if (products.length === 0) {
        content.innerHTML = `
          <div class="no-data">
            <h2>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å•†å“</h2>
            <p>è«‹å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶</p>
          </div>
        `;
        return;
      }

      if (currentViewMode === 'grid') {
        renderGridView(products);
      } else {
        renderListView(products);
      }
    }

    // æ¸²æŸ“åº—å®¶åˆ—è¡¨
    function renderStoreList(stores) {
      return stores.map((store, index) => {
        const localPrice = store.salePrice || store.originalPrice;
        const priceJPY = store.priceJPY || localPrice;
        const convertedPrice = formatPriceInCurrentCurrency(priceJPY);

        return `
          <div class="store-item ${index === 0 ? 'best-price' : ''}">
            <span class="store-badge ${store.store}">${store.storeName}</span>
            <div class="store-info">
              <div class="store-currency">${store.currency}</div>
            </div>
            <div class="store-price">
              <div class="price-local">${convertedPrice}</div>
              ${store.currency !== currentCurrency ? `<div class="price-jpy">${formatPrice(localPrice, store.currency)}</div>` : ''}
            </div>
            <a href="${store.productUrl}" target="_blank" rel="noopener" class="store-link">å‰å¾€</a>
          </div>
        `;
      }).join('');
    }

    // å¡ç‰‡æª¢è¦–
    function renderGridView(products) {
      const content = document.getElementById('content');
      const html = `
        <div class="product-grid">
          ${products.map(product => {
            const isExpanded = expandedProducts.has(product.key);
            return `
              <div class="product-card">
                ${product.imageUrl
                  ? `<img src="${product.imageUrl}" alt="${product.name}" class="product-image" loading="lazy" onerror="this.outerHTML='<div class=\\'product-image-placeholder\\'>ğŸ‚</div>'">`
                  : '<div class="product-image-placeholder">ğŸ‚</div>'
                }
                <div class="product-info">
                  <div class="product-brand">${product.brand || 'æœªçŸ¥å“ç‰Œ'}</div>
                  <div class="product-name">
                    ${product.name || 'æœªçŸ¥å•†å“'}
                    ${product.storeCount > 1 ? `<span class="multi-store-badge">${product.storeCount}åº—æ¯”åƒ¹</span>` : ''}
                  </div>
                  <div class="product-price-summary">
                    <span class="lowest-price">${formatPriceInCurrentCurrency(product.lowestPrice)}</span>
                    <span class="store-count">${product.lowestStore}</span>
                  </div>
                </div>
                <button class="expand-btn ${isExpanded ? 'expanded' : ''}" onclick="toggleExpand('${product.key}')">
                  <span>æŸ¥çœ‹ ${product.storeCount} å®¶åº—å®¶åƒ¹æ ¼</span>
                  <span class="arrow">â–¼</span>
                </button>
                <div class="store-list ${isExpanded ? 'expanded' : ''}">
                  ${renderStoreList(product.stores)}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      content.innerHTML = html;
    }

    // åˆ—è¡¨æª¢è¦–
    function renderListView(products) {
      const content = document.getElementById('content');
      const html = `
        <div class="product-list">
          ${products.map(product => {
            const isExpanded = expandedProducts.has(product.key);
            return `
              <div class="product-card">
                <div class="product-main" onclick="toggleExpand('${product.key}')">
                  <div class="product-image-container">
                    ${product.imageUrl
                      ? `<img src="${product.imageUrl}" alt="${product.name}" class="product-image" loading="lazy" onerror="this.outerHTML='<div class=\\'product-image-placeholder\\'>ğŸ‚</div>'">`
                      : '<div class="product-image-placeholder">ğŸ‚</div>'
                    }
                  </div>
                  <div class="product-info">
                    <div class="product-details">
                      <div class="product-brand">${product.brand || 'æœªçŸ¥å“ç‰Œ'}</div>
                      <div class="product-name">
                        ${product.name || 'æœªçŸ¥å•†å“'}
                        ${product.storeCount > 1 ? `<span class="multi-store-badge">${product.storeCount}åº—</span>` : ''}
                      </div>
                    </div>
                    <div class="product-price-info">
                      <div class="lowest-price">${formatPriceInCurrentCurrency(product.lowestPrice)}</div>
                      <div class="lowest-store">${product.lowestStore}</div>
                    </div>
                  </div>
                  <div class="expand-indicator ${isExpanded ? 'expanded' : ''}">â–¼</div>
                </div>
                <div class="store-list ${isExpanded ? 'expanded' : ''}">
                  ${renderStoreList(product.stores)}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      content.innerHTML = html;
    }

    // è§¸ç™¼æŠ“å–
    async function triggerScrape() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.innerHTML = '<span>â³</span> æŠ“å–ä¸­...';

      showToast('é–‹å§‹æŠ“å–è³‡æ–™ï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜...', 'info');

      try {
        const response = await fetch('/api/scrape', { method: 'POST' });
        const data = await response.json();

        if (response.ok) {
          showToast('æŠ“å–å·²é–‹å§‹ï¼è«‹ç¨å€™å¾Œé‡æ–°è¼‰å…¥', 'success');
          checkScrapeStatus();
        } else {
          showToast(data.error || 'æŠ“å–å¤±æ•—', 'error');
          btn.disabled = false;
          btn.innerHTML = '<span>ğŸ”„</span> æ›´æ–°å…¨éƒ¨è³‡æ–™';
        }
      } catch (error) {
        showToast('è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<span>ğŸ”„</span> æ›´æ–°å…¨éƒ¨è³‡æ–™';
      }
    }

    // é¡¯ç¤ºé€²åº¦æ¢
    function showProgress() {
      document.getElementById('progressContainer').classList.add('active');
    }

    // éš±è—é€²åº¦æ¢
    function hideProgress() {
      document.getElementById('progressContainer').classList.remove('active');
    }

    // æ›´æ–°é€²åº¦æ¢é¡¯ç¤º
    function updateProgressUI(progress) {
      const progressBar = document.getElementById('progressBar');
      const progressStore = document.getElementById('progressStore');
      const progressProducts = document.getElementById('progressProducts');
      const progressMessage = document.getElementById('progressMessage');
      const progressTime = document.getElementById('progressTime');

      // è¨ˆç®—ç¸½é€²åº¦
      let percent = 0;
      if (progress.totalStores > 0 && progress.totalPages > 0) {
        const storeProgress = (progress.storeIndex - 1) / progress.totalStores;
        const pageProgress = progress.currentPage / progress.totalPages / progress.totalStores;
        percent = Math.round((storeProgress + pageProgress) * 100);
      } else if (progress.totalStores > 0) {
        percent = Math.round((progress.storeIndex / progress.totalStores) * 100);
      }
      percent = Math.min(percent, 99); // æœ€å¤š 99%ï¼Œå®Œæˆæ™‚æ‰ 100%

      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';

      progressStore.textContent = `åº—å®¶: ${progress.storeIndex}/${progress.totalStores} ${progress.currentStore || ''}`;
      progressProducts.textContent = `å•†å“: ${progress.productsFound}`;
      progressMessage.textContent = progress.message || 'è™•ç†ä¸­...';
      progressTime.textContent = `å·²èŠ±è²»: ${progress.elapsedTime}ç§’`;
    }

    // æª¢æŸ¥æŠ“å–ç‹€æ…‹
    async function checkScrapeStatus() {
      const btn = document.getElementById('refreshBtn');
      showProgress();

      const check = async () => {
        try {
          const response = await fetch('/api/status');
          const data = await response.json();

          if (data.isScaping) {
            // æ›´æ–°é€²åº¦æ¢
            if (data.progress) {
              updateProgressUI(data.progress);
            }
            setTimeout(check, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
          } else {
            // å®Œæˆ
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            document.getElementById('progressMessage').textContent = 'æŠ“å–å®Œæˆï¼';

            setTimeout(() => {
              hideProgress();
              btn.disabled = false;
              btn.innerHTML = '<span>ğŸ”„</span> æ›´æ–°å…¨éƒ¨è³‡æ–™';
              showToast('æŠ“å–å®Œæˆï¼æ­£åœ¨é‡æ–°è¼‰å…¥...', 'success');
              loadProducts();
            }, 1500);
          }
        } catch (error) {
          hideProgress();
          btn.disabled = false;
          btn.innerHTML = '<span>ğŸ”„</span> æ›´æ–°å…¨éƒ¨è³‡æ–™';
        }
      };

      setTimeout(check, 500);
    }

    // é–‹å•Ÿåº—å®¶ç®¡ç† Modal
    function openStoreModal(tab = 'list') {
      document.getElementById('storeModal').classList.add('active');
      document.getElementById('storeUrl').value = '';
      document.getElementById('storeName').value = '';
      document.getElementById('addStoreResult').className = 'modal-result';
      document.getElementById('addStoreResult').innerHTML = '';
      switchStoreTab(tab);
      if (tab === 'list') {
        loadStoreList();
      }
    }

    // èˆŠçš„å‡½æ•¸ä¿æŒç›¸å®¹æ€§
    function openAddStoreModal() {
      openStoreModal('add');
    }

    // é—œé–‰åº—å®¶ç®¡ç† Modal
    function closeStoreModal() {
      document.getElementById('storeModal').classList.remove('active');
    }

    // èˆŠçš„å‡½æ•¸ä¿æŒç›¸å®¹æ€§
    function closeAddStoreModal() {
      closeStoreModal();
    }

    // åˆ‡æ›åº—å®¶ç®¡ç†åˆ†é 
    function switchStoreTab(tabName) {
      // æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.modal-tab').forEach((tab, index) => {
        if ((tabName === 'list' && index === 0) || (tabName === 'add' && index === 1)) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // é¡¯ç¤ºå°æ‡‰çš„å…§å®¹
      document.getElementById('storeListTab').classList.toggle('active', tabName === 'list');
      document.getElementById('addStoreTab').classList.toggle('active', tabName === 'add');

      // å¦‚æœåˆ‡æ›åˆ°åˆ—è¡¨åˆ†é ï¼Œè¼‰å…¥åº—å®¶åˆ—è¡¨
      if (tabName === 'list') {
        loadStoreList();
      }
    }

    // è¼‰å…¥åº—å®¶åˆ—è¡¨
    async function loadStoreList() {
      const container = document.getElementById('storeListManage');
      container.innerHTML = '<div class="empty-stores">è¼‰å…¥ä¸­...</div>';

      try {
        const response = await fetch('/api/stores');
        const stores = await response.json();

        if (stores.length === 0) {
          container.innerHTML = '<div class="empty-stores">å°šç„¡åº—å®¶</div>';
          return;
        }

        container.innerHTML = stores.map(store => `
          <div class="store-manage-item">
            <div class="store-manage-info">
              <div class="store-manage-name">
                ${store.name}
                <span class="store-manage-type ${store.type || 'builtin'}">${store.type === 'custom' ? 'è‡ªè¨‚' : 'å…§å»º'}</span>
              </div>
              <div class="store-manage-meta">
                ${store.currency} | ${store.country || 'æœªçŸ¥åœ°å€'}
                ${store.baseUrl ? ` | <a href="${store.baseUrl}" target="_blank" style="color: #00d2ff;">é–‹å•Ÿç¶²ç«™</a>` : ''}
              </div>
              ${store.categories && store.categories.length > 0 ? `
                <div class="store-manage-categories" style="font-size: 0.75rem; color: #888; margin-top: 4px;">
                  åˆ†é¡: ${store.categories.map(c => c.name).join(', ')}
                </div>
              ` : ''}
            </div>
            <div class="store-manage-actions">
              ${store.type === 'custom' ? `
                <button class="btn-edit" onclick="editStoreCategories('${store.id}', '${store.name}')" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">åˆ†é¡</button>
                <button class="btn-delete" onclick="deleteStoreFromModal('${store.id}', '${store.name}')">åˆªé™¤</button>
              ` : `
                <span style="color: rgba(255,255,255,0.4); font-size: 0.8rem;">å…§å»ºåº—å®¶</span>
              `}
            </div>
          </div>
        `).join('');
      } catch (error) {
        container.innerHTML = `<div class="empty-stores">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
      }
    }

    // ç·¨è¼¯åº—å®¶åˆ†é¡
    async function editStoreCategories(storeId, storeName) {
      try {
        // å…ˆå–å¾—ç¾æœ‰åˆ†é¡
        const response = await fetch(`/api/stores/${storeId}/categories`);
        const data = await response.json();

        if (!response.ok) {
          showToast(data.error || 'ç„¡æ³•å–å¾—åˆ†é¡è³‡è¨Š', 'error');
          return;
        }

        // é¡¯ç¤ºåˆ†é¡ç·¨è¼¯ UI
        const container = document.getElementById('storeListManage');
        const currentCategories = data.categories || [];

        container.innerHTML = `
          <div style="padding: 15px;">
            <h4 style="margin: 0 0 15px 0;">ç·¨è¼¯ã€Œ${storeName}ã€çš„åˆ†é¡</h4>
            <div id="editCategoryList" style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;">
              ${currentCategories.length > 0 ? currentCategories.map((cat, idx) => `
                <label style="display: flex; align-items: center; padding: 8px; margin: 4px 0; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" id="edit_cat_${idx}" data-category='${JSON.stringify(cat)}' checked style="margin-right: 10px; width: 18px; height: 18px;">
                  <span style="flex: 1;">${cat.name}</span>
                </label>
              `).join('') : '<p style="color: #888; text-align: center;">å°šç„¡åˆ†é¡è¨­å®š</p>'}
            </div>
            <p style="font-size: 0.8rem; color: #888; margin: 10px 0;">
              æç¤ºï¼šè‹¥è¦æ–°å¢åˆ†é¡ï¼Œè«‹é‡æ–°æ¢ç´¢åº—å®¶
            </p>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button onclick="loadStoreList()" class="btn btn-cancel" style="flex: 1;">å–æ¶ˆ</button>
              <button onclick="saveStoreCategories('${storeId}')" class="btn btn-success" style="flex: 1;">å„²å­˜è®Šæ›´</button>
            </div>
          </div>
        `;
      } catch (error) {
        showToast('è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
      }
    }

    // å„²å­˜åº—å®¶åˆ†é¡è¨­å®š
    async function saveStoreCategories(storeId) {
      const checkboxes = document.querySelectorAll('#editCategoryList input[type="checkbox"]');
      const categories = [];

      checkboxes.forEach(cb => {
        if (cb.checked) {
          try {
            const cat = JSON.parse(cb.dataset.category);
            categories.push({ ...cat, enabled: true });
          } catch (e) {}
        }
      });

      if (categories.length === 0) {
        showToast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åˆ†é¡', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/stores/${storeId}/categories`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ categories })
        });

        const data = await response.json();

        if (response.ok) {
          showToast(`å·²æ›´æ–°åˆ†é¡è¨­å®šï¼Œæ‰¾åˆ° ${data.productCount} å€‹å•†å“`, 'success');
          loadStoreList();
          loadProducts();
        } else {
          showToast(data.error || 'æ›´æ–°å¤±æ•—', 'error');
        }
      } catch (error) {
        showToast('è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
      }
    }

    // å¾ Modal ä¸­åˆªé™¤åº—å®¶
    async function deleteStoreFromModal(storeId, storeName) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤åº—å®¶ã€Œ${storeName}ã€å—ï¼Ÿ\n\næ³¨æ„ï¼šé€™å°‡åŒæ™‚åˆªé™¤è©²åº—å®¶çš„æ‰€æœ‰å•†å“è³‡æ–™ã€‚`)) {
        return;
      }

      try {
        const response = await fetch(`/api/stores/${storeId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
          showToast(`å·²åˆªé™¤åº—å®¶: ${storeName}`, 'success');
          loadStoreList(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
          loadProducts();  // é‡æ–°è¼‰å…¥å•†å“
        } else {
          showToast(data.error || 'åˆªé™¤å¤±æ•—', 'error');
        }
      } catch (error) {
        showToast('è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
      }
    }

    // æš«å­˜æ¢ç´¢çµæœ
    let currentExploration = null;

    // Step 1: æ¢ç´¢åº—å®¶åˆ†é¡
    async function exploreStoreCategories(event) {
      if (event) event.preventDefault();

      const url = document.getElementById('storeUrl').value.trim();
      const exploreBtn = document.getElementById('exploreStoreBtn');
      const resultDiv = document.getElementById('addStoreResult');

      if (!url) {
        showToast('è«‹è¼¸å…¥åº—å®¶ç¶²å€', 'error');
        return;
      }

      exploreBtn.disabled = true;
      exploreBtn.textContent = 'æ¢ç´¢ä¸­...';
      resultDiv.className = 'modal-result';
      resultDiv.innerHTML = '';

      try {
        const response = await fetch('/api/stores/explore', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const data = await response.json();

        if (response.ok) {
          currentExploration = data;

          // é¡¯ç¤ºåº—å®¶è³‡è¨Š
          document.getElementById('exploredStoreName').textContent = data.storeName;
          document.getElementById('exploredStoreUrl').textContent = data.baseUrl;

          // é¡¯ç¤ºåˆ†é¡æ¸…å–®
          const categoryListDiv = document.getElementById('categoryList');

          if (data.categories && data.categories.length > 0) {
            categoryListDiv.innerHTML = data.categories.map((cat, idx) => `
              <label style="display: flex; align-items: center; padding: 8px; margin: 4px 0; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="cat_${idx}" data-category-id="${cat.id}" ${cat.enabled ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                <span style="flex: 1;">${cat.name}</span>
              </label>
            `).join('');
          } else {
            // å¦‚æœæ²’æ‰¾åˆ°åˆ†é¡ï¼Œæä¾›ã€Œå…¨éƒ¨å•†å“ã€é¸é …
            categoryListDiv.innerHTML = `
              <label style="display: flex; align-items: center; padding: 8px; margin: 4px 0; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                <input type="checkbox" id="cat_default" data-category-id="default" checked style="margin-right: 10px; width: 18px; height: 18px;">
                <span style="flex: 1;">å…¨éƒ¨å•†å“ (ä½¿ç”¨åŸå§‹ç¶²å€)</span>
              </label>
            `;
            // å»ºç«‹é è¨­åˆ†é¡
            currentExploration.categories = [{
              id: 'default',
              name: 'å…¨éƒ¨å•†å“',
              url: url,
              enabled: true
            }];
          }

          // åˆ‡æ›åˆ° Step 2
          document.getElementById('addStoreStep1').style.display = 'none';
          document.getElementById('addStoreStep2').style.display = 'block';

          showToast(`æ‰¾åˆ° ${data.categories?.length || 0} å€‹åˆ†é¡`, 'success');
        } else {
          resultDiv.className = 'modal-result error';
          resultDiv.innerHTML = `<h4>âœ— æ¢ç´¢å¤±æ•—</h4><p>${data.error}</p>`;
          showToast(data.error, 'error');
        }
      } catch (error) {
        resultDiv.className = 'modal-result error';
        resultDiv.innerHTML = `<h4>âœ— è«‹æ±‚å¤±æ•—</h4><p>${error.message}</p>`;
        showToast('è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
      } finally {
        exploreBtn.disabled = false;
        exploreBtn.textContent = 'æ¢ç´¢åˆ†é¡';
      }
    }

    // è¿”å› Step 1
    function backToStep1() {
      document.getElementById('addStoreStep1').style.display = 'block';
      document.getElementById('addStoreStep2').style.display = 'none';
      document.getElementById('addStoreResult').className = 'modal-result';
      document.getElementById('addStoreResult').innerHTML = '';
      currentExploration = null;
    }

    // Step 2: æäº¤æ–°å¢åº—å®¶ (å«åˆ†é¡)
    async function submitAddStoreWithCategories() {
      if (!currentExploration) {
        showToast('è«‹å…ˆæ¢ç´¢åº—å®¶åˆ†é¡', 'error');
        return;
      }

      const submitBtn = document.getElementById('addStoreSubmitBtn');
      const resultDiv = document.getElementById('addStoreResult');
      const customName = document.getElementById('storeName').value.trim();

      // å–å¾—é¸ä¸­çš„åˆ†é¡
      const selectedCategories = [];
      currentExploration.categories.forEach((cat, idx) => {
        const checkbox = document.getElementById(`cat_${idx}`) || document.getElementById('cat_default');
        if (checkbox && checkbox.checked) {
          selectedCategories.push({ ...cat, enabled: true });
        }
      });

      if (selectedCategories.length === 0) {
        showToast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åˆ†é¡', 'error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'æ–°å¢ä¸­...';
      resultDiv.className = 'modal-result';
      resultDiv.innerHTML = '';

      try {
        const response = await fetch('/api/stores/with-categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url: currentExploration.originalUrl,
            name: customName || null,
            categories: selectedCategories
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          resultDiv.className = 'modal-result success';
          resultDiv.innerHTML = `
            <h4>âœ“ æ–°å¢æˆåŠŸ!</h4>
            <p><strong>åº—å®¶:</strong> ${data.store.name}</p>
            <p><strong>åˆ†é¡:</strong> ${data.categories?.map(c => c.name).join(', ') || 'å…¨éƒ¨'}</p>
            <p><strong>æ‰¾åˆ°å•†å“:</strong> ${data.productCount} ä»¶</p>
            ${data.sampleProducts && data.sampleProducts.length > 0 ? `
              <p style="margin-top: 10px;"><strong>ç¯„ä¾‹å•†å“:</strong></p>
              <ul style="margin-left: 20px; font-size: 0.85rem;">
                ${data.sampleProducts.map(p => `<li>${p.brand || ''} ${p.name}</li>`).join('')}
              </ul>
            ` : ''}
          `;
          showToast(`å·²æ–°å¢åº—å®¶: ${data.store.name}`, 'success');

          // 2ç§’å¾Œé—œé–‰ä¸¦é‡æ–°è¼‰å…¥
          setTimeout(() => {
            closeStoreModal();
            backToStep1();
            loadProducts();
          }, 2000);
        } else {
          resultDiv.className = 'modal-result error';
          resultDiv.innerHTML = `<h4>âœ— æ–°å¢å¤±æ•—</h4><p>${data.error}</p>`;
          showToast(data.error, 'error');
        }
      } catch (error) {
        resultDiv.className = 'modal-result error';
        resultDiv.innerHTML = `<h4>âœ— è«‹æ±‚å¤±æ•—</h4><p>${error.message}</p>`;
        showToast('è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'æ–°å¢åº—å®¶';
      }
    }

    // èˆŠç‰ˆæäº¤æ–°å¢åº—å®¶ (ä¿ç•™ç›¸å®¹æ€§)
    async function submitAddStore(event, forceAccept = false) {
      if (event) event.preventDefault();

      const url = document.getElementById('storeUrl').value.trim();
      const name = document.getElementById('storeName').value.trim();
      const submitBtn = document.getElementById('addStoreSubmitBtn');
      const resultDiv = document.getElementById('addStoreResult');

      if (!url) {
        showToast('è«‹è¼¸å…¥åº—å®¶ç¶²å€', 'error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = forceAccept ? 'ç¢ºèªæ–°å¢ä¸­...' : 'åµæ¸¬ä¸­...';
      resultDiv.className = 'modal-result';
      resultDiv.innerHTML = '';

      try {
        const response = await fetch('/api/stores', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url, name: name || null, forceAccept })
        });

        const data = await response.json();

        // è™•ç†éœ€è¦ç¢ºèªçš„æƒ…æ³ (HTTP 202)
        if (response.status === 202 && data.requiresConfirmation) {
          const v = data.validation;
          resultDiv.className = 'modal-result warning';
          resultDiv.innerHTML = `
            <h4>âš ï¸ éœ€è¦ç¢ºèª</h4>
            <p>${data.message}</p>
            <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
              <p style="font-size: 0.85rem; margin-bottom: 8px;"><strong>ğŸ“Š äº¤å‰é©—è­‰çµæœ:</strong></p>
              <p style="font-size: 0.8rem; margin: 2px 0;">â€¢ ä¸»è¦æ–¹æ³• (${v.primary.method}): ${v.primary.count} ä»¶</p>
              <p style="font-size: 0.8rem; margin: 2px 0;">â€¢ é©—è­‰æ–¹æ³• (${v.secondary.method}): ${v.secondary.count} ä»¶</p>
              <p style="font-size: 0.8rem; margin: 2px 0;">â€¢ å·®ç•°: ${v.differencePercent.toFixed(1)}%</p>
              <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 8px 0;">
              <p style="font-size: 0.8rem; margin: 2px 0;"><strong>åˆä½µå¾Œå•†å“æ•¸:</strong> ${v.merged.count} ä»¶</p>
              <p style="font-size: 0.75rem; color: #aaa; margin: 2px 0;">
                (ä¸»è¦ç¨æœ‰: ${v.details.onlyInPrimary} | é©—è­‰ç¨æœ‰: ${v.details.onlyInSecondary} | å…±æœ‰: ${v.details.inBoth})
              </p>
              ${v.warnings && v.warnings.length > 0 ? `
                <div style="margin-top: 8px; padding: 6px; background: rgba(255,193,7,0.2); border-radius: 4px;">
                  <p style="font-size: 0.75rem; color: #ffc107;">${v.warnings.join('<br>')}</p>
                </div>
              ` : ''}
            </div>
            ${data.preview && data.preview.sampleProducts && data.preview.sampleProducts.length > 0 ? `
              <p style="margin-top: 10px;"><strong>ç¯„ä¾‹å•†å“:</strong></p>
              <ul style="margin-left: 20px; font-size: 0.85rem; max-height: 100px; overflow-y: auto;">
                ${data.preview.sampleProducts.map(p => `<li>${p.brand || ''} ${p.name}</li>`).join('')}
              </ul>
            ` : ''}
            <div style="margin-top: 15px; display: flex; gap: 10px;">
              <button type="button" onclick="confirmAddStore()" class="btn btn-primary" style="flex: 1;">
                ç¢ºèªæ–°å¢ (${v.merged.count} ä»¶å•†å“)
              </button>
              <button type="button" onclick="cancelAddStore()" class="btn btn-secondary" style="flex: 1;">
                å–æ¶ˆ
              </button>
            </div>
          `;
          showToast('äº¤å‰é©—è­‰ç™¼ç¾å·®ç•°ï¼Œè«‹ç¢ºèªæ˜¯å¦ç¹¼çºŒ', 'info');
          submitBtn.disabled = false;
          submitBtn.textContent = 'æ–°å¢åº—å®¶';
          return;
        }

        if (response.ok) {
          const validation = data.validation || {};

          resultDiv.className = `modal-result success`;
          resultDiv.innerHTML = `
            <h4>âœ“ æ–°å¢æˆåŠŸ!</h4>
            <p><strong>åº—å®¶:</strong> ${data.store.name}</p>
            <p><strong>æ‰¾åˆ°å•†å“:</strong> ${data.productCount} ä»¶</p>
            ${validation.merged ? `
              <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                <p style="font-size: 0.85rem; margin-bottom: 5px;"><strong>ğŸ“Š äº¤å‰é©—è­‰çµæœ:</strong></p>
                <p style="font-size: 0.8rem; margin: 2px 0;">
                  â€¢ ç‹€æ…‹: ${validation.status === 'auto_merged' ? 'âœ“ è‡ªå‹•åˆä½µ' : validation.status === 'merged_with_warning' ? 'âš ï¸ åˆä½µï¼ˆæœ‰è­¦å‘Šï¼‰' : validation.status === 'skipped_js_only' ? 'â„¹ï¸ ç´” JS ç¶²ç«™ï¼ˆè·³éé©—è­‰ï¼‰' : 'âœ“ ç¢ºèªåˆä½µ'}
                </p>
                <p style="font-size: 0.8rem; margin: 2px 0;">â€¢ å·®ç•°: ${(validation.differencePercent || 0).toFixed(1)}%</p>
                <p style="font-size: 0.8rem; margin: 2px 0;">â€¢ åˆä½µå•†å“: ${validation.merged.count} ä»¶ (ä¸»è¦: ${validation.merged.fromPrimary} + é©—è­‰: ${validation.merged.fromSecondary})</p>
              </div>
            ` : ''}
            ${data.sampleProducts && data.sampleProducts.length > 0 ? `
              <p style="margin-top: 10px;"><strong>ç¯„ä¾‹å•†å“:</strong></p>
              <ul style="margin-left: 20px; font-size: 0.85rem;">
                ${data.sampleProducts.map(p => `<li>${p.brand || ''} ${p.name} - ${formatPrice(p.salePrice || p.originalPrice, data.store.currency)}</li>`).join('')}
              </ul>
            ` : ''}
          `;
          showToast(`å·²æ–°å¢åº—å®¶: ${data.store.name}`, 'success');

          // 2ç§’å¾Œé—œé–‰ä¸¦é‡æ–°è¼‰å…¥
          setTimeout(() => {
            closeAddStoreModal();
            loadProducts();
          }, 2000);
        } else {
          resultDiv.className = 'modal-result error';
          resultDiv.innerHTML = `
            <h4>âœ— æ–°å¢å¤±æ•—</h4>
            <p>${data.error}</p>
          `;
          showToast(data.error, 'error');
        }
      } catch (error) {
        resultDiv.className = 'modal-result error';
        resultDiv.innerHTML = `
          <h4>âœ— è«‹æ±‚å¤±æ•—</h4>
          <p>${error.message}</p>
        `;
        showToast('è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'æ–°å¢åº—å®¶';
      }
    }

    // ç¢ºèªæ–°å¢åº—å®¶ï¼ˆå·®ç•°éå¤§æ™‚çš„äººå·¥ç¢ºèªï¼‰
    function confirmAddStore() {
      submitAddStore(null, true);
    }

    // å–æ¶ˆæ–°å¢åº—å®¶
    function cancelAddStore() {
      const resultDiv = document.getElementById('addStoreResult');
      resultDiv.className = 'modal-result';
      resultDiv.innerHTML = '';
      document.getElementById('storeUrl').value = '';
      document.getElementById('storeName').value = '';
      showToast('å·²å–æ¶ˆæ–°å¢', 'info');
    }

    // åˆªé™¤è‡ªè¨‚åº—å®¶
    async function deleteStore(storeId, storeName) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤åº—å®¶ã€Œ${storeName}ã€å—ï¼Ÿ`)) {
        return;
      }

      try {
        const response = await fetch(`/api/stores/${storeId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
          showToast(`å·²åˆªé™¤åº—å®¶: ${storeName}`, 'success');
          loadProducts();
        } else {
          showToast(data.error || 'åˆªé™¤å¤±æ•—', 'error');
        }
      } catch (error) {
        showToast('è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
      }
    }

    // é»æ“Š Modal å¤–éƒ¨é—œé–‰
    document.addEventListener('click', (e) => {
      if (e.target.id === 'storeModal') {
        closeStoreModal();
      }
    });

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>
