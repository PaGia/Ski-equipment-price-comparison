# 架構設計

## 系統架構圖

```
┌─────────────────────────────────────────────────────────┐
│                    前端 (public/index.html)              │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │ 搜尋篩選 │ │ 商品列表 │ │ 價格比較 │ │ 店家管理 │       │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │
└─────────────────────────┬───────────────────────────────┘
                          │ HTTP API
┌─────────────────────────▼───────────────────────────────┐
│                   Express Server (server.js)             │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐    │
│  │ /api/products│ │ /api/stores  │ │ /api/scrape  │    │
│  └──────────────┘ └──────────────┘ └──────────────┘    │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────┐
│                   Scraper (scraper.js)                   │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐          │
│  │   Axios    │ │  Cheerio   │ │ Puppeteer  │          │
│  │ (靜態頁面) │ │ (HTML解析) │ │ (動態頁面) │          │
│  └────────────┘ └────────────┘ └────────────┘          │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────┐
│                   Data Layer (data/)                     │
│  ┌────────────────────┐ ┌────────────────────┐         │
│  │  snowboards.json   │ │ custom-stores.json │         │
│  │   (商品資料)        │ │   (店家配置)        │         │
│  └────────────────────┘ └────────────────────┘         │
└─────────────────────────────────────────────────────────┘
```

## 檔案結構

```
├── server.js              # Express 伺服器 + API 路由
├── scraper.js             # 爬蟲核心邏輯（3000+ 行）
├── package.json           # 專案配置
├── data/
│   ├── snowboards.json    # 商品資料 (自動生成)
│   └── custom-stores.json # 自訂店家配置
├── public/
│   └── index.html         # 前端單頁應用
└── memory-bank/           # AI 記憶庫
```

## 核心模組 (scraper.js)

### 店家配置
- `BUILT_IN_STORES` - 內建店家設定
- `loadCustomStores()` / `saveCustomStores()` - 自訂店家管理
- `getAllStores()` - 取得所有店家

### 爬蟲函數
- `scrapeWithPuppeteer()` - Puppeteer 爬蟲（BASE 平台）
- `scrapeShopify()` - Shopify JSON API 爬蟲
- `scrapeMurasaki()` - Murasaki 專用爬蟲
- `scrapeGeneric()` - 通用爬蟲

### 資料處理
- `parsePrice()` - 價格解析（含幣別偵測）
- `normalizeProductName()` - 商品名稱標準化
- `generateProductKey()` - 生成商品唯一 ID
- `mergeProducts()` - 合併相同商品

### 匯出函數
- `scrapeAll()` - 執行全部爬取
- `addCustomStore()` - 新增自訂店家
- `removeCustomStore()` - 移除自訂店家
- `getProgress()` - 取得爬取進度

## API 端點

| 端點 | 方法 | 功能 |
|------|------|------|
| `/api/products` | GET | 取得所有商品 |
| `/api/stores` | GET | 取得店家列表 |
| `/api/stores` | POST | 新增自訂店家 |
| `/api/stores/:id` | DELETE | 刪除自訂店家 |
| `/api/stores/:id/categories` | GET/PUT | 店家分類管理 |
| `/api/stores/explore` | POST | 探索店家分類 |
| `/api/scrape` | POST | 手動觸發爬取 |
| `/api/status` | GET | 爬取狀態 |

## 開發流程與工具分工

### 1. 程式碼建構階段
**負責工具**: Claude Code for VS Code
**職責**:
- 實際程式碼撰寫與實作
- 檔案建立、修改、重構
- 程式邏輯實現
- Bug 修復實作
- **實作完成後刪除測試用檔案**
- **實作完成後執行 git commit**
- **工作原則**: 慢慢想 (think hard)、不清楚先問

### 2. 規劃階段 (Planning)
**負責工具**: GitHub Copilot
**職責**:
- 需求分析與討論
- 技術方案規劃
- 架構設計建議
- 實作計畫制定
- **注意**: 僅負責規劃，不負責實作
- **工作原則**: 慢慢想 (think hard)、不清楚先問

### 3. 除錯階段 (Debug)
**負責工具**: GitHub Copilot
**職責**:
- 問題診斷與分析
- 錯誤根因調查
- 完整除錯報告產出
- 解決方案建議
- **注意**: 僅負責問題分析，不負責修復實作
- **工作原則**: 慢慢想 (think hard)、不清楚先問

## 關鍵設計決策

### 1. 無資料庫設計
**決策**: 使用 JSON 檔案儲存
**原因**:
- 資料量不大（數百筆商品）
- 部署簡單，無需額外資料庫
- 容易備份與版本控制

### 2. 雙重爬蟲策略
**決策**: Axios（靜態）+ Puppeteer（動態）
**原因**:
- Axios 速度快、資源省
- Puppeteer 處理 JavaScript 渲染
- 根據平台自動選擇

### 3. 商品合併邏輯
**決策**: 以「品牌 + 標準化名稱」作為唯一識別
**原因**:
- 不同店家可能有不同命名
- 去除年份/尺寸後比對
- 同款商品聚合比價
